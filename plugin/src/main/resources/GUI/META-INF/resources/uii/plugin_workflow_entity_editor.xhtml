<ui:composition
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:composite="http://xmlns.jcp.org/jsf/composite"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:x="http://myfaces.apache.org/tomahawk"
    xmlns:intranda="http://xmlns.jcp.org/jsf/composite/composites"
    xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
    xmlns:p="http://primefaces.org/ui"
    xmlns:entity="http://entity.goobi.io/facelets"
    xmlns:jsf="http://xmlns.jcp.org/jsf">

    <composite:interface>
    </composite:interface>

    <composite:implementation>

        <style>
.breadcrumbs {
    display: none;
}

.grid {
    display: grid;
    grid-template-columns: 50% 50%;
    grid-template-rows: auto auto;
    grid-row-gap: 1px;
    grid-column-gap: 9px;
}

.grid .head {
    grid-column-start: span 2;
}

.head ul {
    list-style-type: none;
    float: left;
    margin: 0;
    padding: 2px 5px;
}

.head ul li {
    float: left;
    margin-right: 10px;
}

.grid .left, .grid .right {
    min-height: 300px;
}

.grid .right {
    display: flex;
    flex-direction: column;
    flex-wrap: wrap;
    justify-content: space-evenly;
    align-items: stretch;
    align-content: stretch;
}

.flex {
    flex-grow: 1;
}

.breadcrumb-button {
    display: block;
    padding: 2px 6px;
    float: left;
    background: #fff;
    transform: skew(45deg);
    margin-top: 3px;
}

.breadcrumb-button i {
    margin-right: 5px;
}

.box-content {
    min-height: 200px;
}

.skew-fix {
    display: inline-block;
    transform: skew(-45deg);
    margin-left: 10px;
    margin-right: 10px;
}

.box .box-title h3 {
    color: inherit;
}

.toggle {
    background: #f6f6f6;
    padding: 0px 2px;
}

.toggle-on {
    color: green;
}

.badge-empty {
    background-color: #fff;
    border: 1px solid #777;
}

.badge-filled {
    
}

.badge {
    margin-left: 5px;
    margin-right: 5px;
    margin-bottom: 5px;
    margin-top: 5px;
    font-weight: normal;
}

.badge a {
    color: #fff;
    /*     font-size: larger; */
}

.badge-empty a {
    color: #777;
}

.badge-area {
    display: flex;
    /*     justify-content: flex-end; */
    flex-wrap: wrap;
    border-bottom: 1px solid #ddd;
    background: #f6f6f6;
}

.badge-bordered {
    color: #666;
    border-radius: 10px;
    text-align: center;
    white-space: nowrap;
    display: inline-block;
    min-width: 10px;
    padding: 3px 7px;
    font-size: 12px;
    line-height: 1;
    margin-left: 5px;
    margin-right: 5px;
    border: 1px solid;
}

.field-label {
    color: #666;
    padding-bottom: 5px;
    display: block;
}

.field-label-language {
    margin-top: 5px;
}

.language-field {
    display: grid;
    grid-template-columns: 20% 80%;
    grid-template-rows: auto;
}

.group-metadata:not(:last-child) {
    margin-bottom: 10px;
}

.vocabulary-search {
    display: grid;
    grid-template-columns: 90% 10%;
    grid-template-rows: auto;
}

.viaf-btn {
    padding: 2px 5px;
    border: 1px solid #ccc;
    background: #fff;
    height: 26px;
}

.toggle-btn, .toggle-btn:hover {
    background: #fff;
}

.source-btn, source-btn:hover {
    background: #fff;
    padding: 0px 5px;
}

.viaf-btn img {
    width: 12px;
    height: 12px;
}

.viaf-btn:hover {
    background: #fff;
}

.form-group .vocabulary-searchfield {
    border-left: 0 !important;
}

.vocabulary-searcharea {
    border-bottom: 0 !important;
}

.source {
    display: grid;
    grid-template-columns: 90% 10%;
    grid-template-rows: auto;
}

.source:not(:last-child) {
    border-bottom: 1px solid #ccc;
    margin-bottom: 5px;
    padding-bottom: 5px;
}

.close {
    color: #fff;
    float: right;
    opacity: .5;
}

.modal-dialog {
    width: 75%;
}

.noborder {
    border: 0 !important;
}

.nobackground {
    background: #fff !important;
}

.main-area {
    max-height: calc(100vh - 322px);
    overflow-y: auto;
}

.relation-row {
    display: grid;
    grid-template-columns: 50px auto 80px 50px;
    grid-template-rows: auto auto;
    margin-bottom: 10px;
}

.sources {
    padding-left: 0px;
    padding-right: 0px;
    max-height: 300px;
    overflow-y: auto;
}

.noborder {
    border: 0;
    background: #fff !important;
}
</style>

        <div class="grid">
            <div class="head">
                <h:form>
                    <ul>
                        <ui:repeat
                            var="breadcrumb"
                            value="#{NavigationForm.workflowPlugin.breadcrumbList}">
                            <li>
                                <entity:entity_breadcrumb
                                    entityType="#{breadcrumb.entityType}"
                                    entityName="#{breadcrumb.entityName}"
                                    entityColor="#{breadcrumb.color}"
                                    entityIcon="#{breadcrumb.icon}" />
                            </li>
                        </ui:repeat>

                    </ul>
                </h:form>
            </div>

            <div class="left">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="box box-color box-bordered #{NavigationForm.workflowPlugin.entity.currentType.name}">
                            <div
                                class="box-title"
                                jsf:style="background: #{NavigationForm.workflowPlugin.entity.currentType.color}; border-color: #{NavigationForm.workflowPlugin.entity.currentType.color};">
                                <h3>
                                    <i class="fa #{NavigationForm.workflowPlugin.entity.currentType.icon}" />

                                    <h:outputText value="#{NavigationForm.workflowPlugin.entity.entityName}" />
                                </h3>

                                <button
                                    class="btn pull-right toggle"
                                    jsf:id="save"
                                    jsf:action="#{NavigationForm.workflowPlugin.saveEntity}">
                                    <i class="fa fa-floppy-o" />

                                </button>

                            </div>
                            <div
                                class="box-content nopadding"
                                jsf:style="border-color: #{NavigationForm.workflowPlugin.entity.currentType.color}; min-height: 600px;">

                                <h:form
                                    styleClass="form-horizontal form-bordered"
                                    prependId="false"
                                    enctype="multipart/form-data"
                                    id="metadataForm">

                                    <!-- badges area -->
                                    <h:panelGroup
                                        id="badge-area"
                                        layout="block"
                                        styleClass="badge-area">
                                        <x:dataList
                                            var="item"
                                            value="#{NavigationForm.workflowPlugin.entity.metadataFieldList}">
                                            <ui:fragment>
                                                <entity:entity_badge
                                                    styleclassname="#{!item.filled ? 'badge-empty' : 'badge-filled'}"
                                                    fieldname="#{msgs[item.name]}"
                                                    showfield="#{item.showField}" />
                                            </ui:fragment>
                                        </x:dataList>
                                    </h:panelGroup>

                                    <!-- list all metadata fields -->
                                    <div class="main-area">
                                        <ui:repeat
                                            value="#{NavigationForm.workflowPlugin.entity.metadataFieldList}"
                                            var="configuredField"
                                            varStatus="status">
                                            <ui:repeat
                                                var="field"
                                                value="#{configuredField.metadataList}"
                                                rendered="#{configuredField.showField}">

                                                <div class="form-group">
                                                    <div class="col-sm-3 control-label">

                                                        <h:outputLabel
                                                            for="field_#{status.index}"
                                                            value="#{msgs[configuredField.label]}" />

                                                        <!-- delete button -->
                                                        <button
                                                            class="btn pull-right toggle"
                                                            jsf:id="remove"
                                                            jsf:action="#{NavigationForm.workflowPlugin.entity.removeMetadata(field)}">
                                                            <i class="fa fa-minus-circle" />
                                                            <f:ajax
                                                                execute="@this"
                                                                render="@form" />
                                                        </button>


                                                        <!-- duplicate button -->
                                                        <button
                                                            class="btn pull-right toggle"
                                                            jsf:id="duplicate"
                                                            jsf:rendered="#{field.configField.repeatable}"
                                                            jsf:action="#{NavigationForm.workflowPlugin.entity.duplicateMetadata(configuredField)}">
                                                            <i class="fa fa-plus-circle" />
                                                            <f:ajax
                                                                execute="@this"
                                                                render="@form" />
                                                        </button>

                                                        <!-- publish button -->
                                                        <button
                                                            class="btn pull-right toggle"
                                                            jsf:id="toggle-export"
                                                            jsf:rendered="#{field.displayPublishButton}">
                                                            <i class="fa #{field.publishField.booleanValue == false?'fa fa-toggle-off':'fa fa-toggle-on toggle-on'}" />
                                                            <f:ajax
                                                                execute="@this"
                                                                render="@this" />
                                                            <f:setPropertyActionListener
                                                                value="#{not field.publishField.booleanValue}"
                                                                target="#{field.publishField.booleanValue}" />
                                                        </button>


                                                    </div>

                                                    <h:panelGroup
                                                        layout="block"
                                                        rendered="#{!field.configField.group}"
                                                        styleClass="col-sm-9">

                                                        <ui:fragment rendered="#{field.configField.fieldType == 'input' or field.configField.fieldType == 'generated'}">
                                                            <x:inputText
                                                                styleClass="form-control"
                                                                value="#{field.metadata.value}"
                                                                required="false"
                                                                id="field_#{status.index}"
                                                                readonly="#{field.configField.readonly  or field.configField.fieldType == 'generated'}">
                                                                <f:ajax
                                                                    execute="@this"
                                                                    render="badge-area"
                                                                    event="blur" />
                                                            </x:inputText>
                                                        </ui:fragment>

                                                        <ui:fragment rendered="#{field.configField.fieldType == 'checkbox'}">
                                                            <h:selectBooleanCheckbox
                                                                styleClass="form-control checkbox-height-fix"
                                                                style="width: auto;"
                                                                value="#{field.booleanValue}">
                                                                <f:ajax
                                                                    event="change"
                                                                    render="badge-area" />
                                                            </h:selectBooleanCheckbox>
                                                        </ui:fragment>
                                                        <ui:fragment rendered="#{field.configField.fieldType == 'select'}">
                                                            <h:selectOneMenu
                                                                styleClass="form-control"
                                                                value="#{field.metadata.value}">
                                                                <f:ajax
                                                                    event="change"
                                                                    render="badge-area" />
                                                                <f:selectItem
                                                                    itemValue=""
                                                                    itemLabel="#{msgs.bitteAuswaehlen}"
                                                                    itemDisabled="true" />
                                                                <f:selectItems
                                                                    value="#{field.configField.valueList}"
                                                                    var="item"
                                                                    itemLabel="#{item}"
                                                                    itemValue="#{item}" />
                                                            </h:selectOneMenu>
                                                        </ui:fragment>

                                                        <ui:fragment rendered="#{field.configField.fieldType == 'vocabularyList'}">
                                                            <h:selectOneMenu
                                                                styleClass="form-control"
                                                                value="#{field.vocabularyValue}">
                                                                <f:ajax
                                                                    event="change"
                                                                    render="badge-area" />
                                                                <f:selectItem
                                                                    itemValue=""
                                                                    itemLabel="#{msgs.bitteAuswaehlen}"
                                                                    itemDisabled="false" />
                                                                <f:selectItems
                                                                    value="#{field.configField.vocabularyList}"
                                                                    var="item"
                                                                    itemLabel="#{item}"
                                                                    itemValue="#{item}" />
                                                            </h:selectOneMenu>
                                                        </ui:fragment>

                                                    </h:panelGroup>

                                                    <h:panelGroup
                                                        id="group"
                                                        layout="block"
                                                        rendered="#{field.configField.group}"
                                                        styleClass="col-sm-9">
                                                        <ui:repeat
                                                            var="subfield"
                                                            value="#{field.subfields}">
                                                            <h:panelGroup
                                                                layout="block"
                                                                styleClass="group-metadata #{subfield.configField.labelPosition == 'left' ? 'language-field' : ''}"
                                                                rendered="#{subfield.configField.fieldType != 'language' and subfield.configField.fieldType != 'publish'}">

                                                                <h:outputText
                                                                    styleClass="field-label"
                                                                    value="#{msgs[subfield.configField.label]}"
                                                                    rendered="#{subfield.configField.fieldType != 'publish' and subfield.configField.labelPosition != 'none'}" />

                                                                <x:inputText
                                                                    styleClass="form-control"
                                                                    value="#{subfield.metadata.value}"
                                                                    required="false"
                                                                    rendered="#{subfield.configField.fieldType == 'input' or subfield.configField.fieldType == 'generated'}"
                                                                    readonly="#{subfield.configField.readonly  or subfield.configField.fieldType == 'generated'}">
                                                                    <f:ajax
                                                                        execute="@this"
                                                                        render="badge-area"
                                                                        event="blur" />
                                                                </x:inputText>

                                                                <x:inputTextarea
                                                                    styleClass="form-control"
                                                                    value="#{subfield.metadata.value}"
                                                                    required="false"
                                                                    rendered="#{subfield.configField.fieldType == 'textarea'}"
                                                                    readonly="#{subfield.configField.readonly}">
                                                                    <f:ajax
                                                                        execute="@this"
                                                                        render="badge-area"
                                                                        event="blur" />
                                                                </x:inputTextarea>

                                                                <ui:fragment rendered="#{subfield.configField.fieldType == 'select'}">
                                                                    <h:selectOneMenu
                                                                        styleClass="form-control"
                                                                        value="#{subfield.metadata.value}">
                                                                        <f:ajax
                                                                            event="change"
                                                                            render="badge-area" />
                                                                        <f:selectItem
                                                                            itemValue=""
                                                                            itemLabel="#{msgs.bitteAuswaehlen}"
                                                                            itemDisabled="true" />
                                                                        <f:selectItems
                                                                            value="#{subfield.configField.valueList}"
                                                                            var="item"
                                                                            itemLabel="#{item}"
                                                                            itemValue="#{item}" />
                                                                    </h:selectOneMenu>
                                                                </ui:fragment>

                                                                <ui:fragment rendered="#{subfield.configField.fieldType == 'vocabularyList'}">
                                                                    <h:selectOneMenu
                                                                        styleClass="form-control"
                                                                        value="#{subfield.vocabularyValue}">
                                                                        <f:ajax
                                                                            event="change"
                                                                            render="badge-area" />
                                                                        <f:selectItem
                                                                            itemValue=""
                                                                            itemLabel="#{msgs.bitteAuswaehlen}"
                                                                            itemDisabled="false" />
                                                                        <f:selectItems
                                                                            value="#{subfield.configField.vocabularyList}"
                                                                            var="item"
                                                                            itemLabel="#{item}"
                                                                            itemValue="#{item}" />
                                                                    </h:selectOneMenu>
                                                                </ui:fragment>

                                                                <ui:fragment rendered="#{subfield.configField.fieldType == 'vocabularySearch'}">
                                                                    <div class="vocabulary-search">
                                                                        <x:inputText
                                                                            styleClass="form-control"
                                                                            value="#{subfield.metadata.value}"
                                                                            required="false"
                                                                            id="field_#{status.index}"
                                                                            readonly="true">
                                                                            <f:ajax
                                                                                execute="@this"
                                                                                render="badge-area"
                                                                                event="blur" />
                                                                        </x:inputText>
                                                                        <span>
                                                                            <button
                                                                                jsf:id="vocabularySearch"
                                                                                class="btn change-icon vocabularySearchIndexTrigger btn--icon-light metadataButton pull-right viaf-btn"
                                                                                title="#{msgs.NORM_vocabularySearch}"
                                                                                aria-label="#{msgs.NORM_vocabularySearch}"
                                                                                type="button"
                                                                                jsf:onclick="$('#vocabularySearchBox').modal('show');">
                                                                                <img
                                                                                    class="toggle"
                                                                                    style="width: 16px;"
                                                                                    alt="Vocabulary"
                                                                                    src="template/img/Icons_Vocabulary_grey.png" />
                                                                                <img
                                                                                    class="toggle"
                                                                                    style="width: 16px;"
                                                                                    alt="Vocabulary"
                                                                                    src="template/img/Icons_Vocabulary_color.png" />
                                                                                <f:setPropertyActionListener
                                                                                    value="#{subfield}"
                                                                                    target="#{NavigationForm.workflowPlugin.searchField}" />
                                                                                <f:ajax
                                                                                    execute="@this"
                                                                                    render=":vocabularySearchModalContent" />
                                                                                <f:passThroughAttribute
                                                                                    name="data-toggle"
                                                                                    value="tooltip" />
                                                                                <f:passThroughAttribute
                                                                                    name="data-placement"
                                                                                    value="top" />
                                                                            </button>
                                                                        </span>
                                                                    </div>
                                                                </ui:fragment>
                                                                <ui:fragment rendered="#{subfield.configField.fieldType == 'fileupload'}">

                                                                    <h:inputFile
                                                                        id="thirdtab_fileupload3"
                                                                        value="#{subfield.uploadedFile}"
                                                                        storage="file"
                                                                        styleClass="form-control form-control-file"
                                                                        style="border: 0;padding-left: 0px;"
                                                                        required="false">
                                                                        <f:ajax
                                                                            listener="#{subfield.uploadFile}"
                                                                            render="thirdtab_fileupload3_message" />
                                                                    </h:inputFile>
                                                                </ui:fragment>
                                                                <ui:fragment
                                                                    rendered="#{subfield.configField.fieldType == 'date'}"
                                                                    id="group">
                                                                    <!-- TODO show wrong syntax errors, add date picker validator="#{subfield.dateValidator}" -->
                                                                    <x:inputText
                                                                        styleClass="form-control"
                                                                        value="#{subfield.metadata.value}"
                                                                        required="false"
                                                                        readonly="false"
                                                                        id="dateField">
                                                                        <f:ajax
                                                                            execute="@this"
                                                                            render="badge-area group"
                                                                            event="blur" />
                                                                    </x:inputText>
                                                                    <h:panelGroup
                                                                        layout="block"
                                                                        rendered="#{!subfield.valid}"
                                                                        styleClass="font-danger validation-message">
                                                                        <h:outputText value="#{subfield.validationErrorMessage}" />
                                                                    </h:panelGroup>

                                                                </ui:fragment>

                                                            </h:panelGroup>
                                                        </ui:repeat>
                                                        <ui:include src="includes/sources.xhtml" />
                                                    </h:panelGroup>
                                                </div>
                                            </ui:repeat>
                                        </ui:repeat>
                                        <button
                                            class="btn "
                                            jsf:id="generateBibliography"
                                            jsf:action="#{NavigationForm.workflowPlugin.entity.generateBibliography}">
                                            <i class="fa fa-plus-circle" />
                                            #{msgs.plugin_workflow_entity_createBibliography}
                                            <f:ajax
                                                execute="@this"
                                                render="@form" />
                                        </button>
                                    </div>
                                    <!-- vocabulary search modal -->
                                    <ui:include src="includes/vocabulary_search_modal.xhtml" />

                                    <!-- sources modal -->
                                    <ui:include src="includes/source_modal.xhtml" />
                                </h:form>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
            <div class="right">
                <div class="row flex">
                    <h:form>
                        <ui:repeat
                            var="type"
                            value="#{NavigationForm.workflowPlugin.entity.linkedRelationships}">

                            <ui:include src="includes/linked_entities.xhtml" />

                        </ui:repeat>

                    </h:form>
                </div>

            </div>



            <!-- link entity modal -->
            <ui:include src="includes/entity_modal.xhtml" />

            <h:inputHidden
                value="#{NavigationForm.workflowPlugin.mainScrollPosition}"
                id="scrollpos" />

        </div>


        <script type="text/javascript">
                                    jsf.ajax.addOnEvent( function( data ) {
                                        var ajaxstatus = data.status;
                                        switch ( ajaxstatus ) {
                                            case "begin":
                                                var scrollPosition = $( '.main-area' ).scrollTop();
                                                $( '#scrollpos' ).val( scrollPosition );
                                                break;
                                            case "success":
                                                var scrollPosition = $( '#scrollpos' ).val();
                                                $( '.main-area' ).scrollTop( scrollPosition )
                                                break;
                                        }
                                    } );
                                </script>

    </composite:implementation>
</ui:composition>